-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. Profiles Table (User Management)
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    full_name TEXT,
    role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin')),
    credits_cv INTEGER DEFAULT 3,
    credits_chat INTEGER DEFAULT 50,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS for profiles
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own profile" 
ON profiles FOR SELECT 
USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile" 
ON profiles FOR UPDATE 
USING (auth.uid() = id);

-- 2. CV Sessions Table (Individual Service)
CREATE TABLE cv_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'downloaded', 'archived')),
    original_pdf_url TEXT,
    latest_draft_url TEXT,
    final_pdf_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS for cv_sessions
ALTER TABLE cv_sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own sessions" 
ON cv_sessions FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own sessions" 
ON cv_sessions FOR INSERT 
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own sessions" 
ON cv_sessions FOR UPDATE 
USING (auth.uid() = user_id);

-- 3. Chat Messages Table (Chat History)
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_id UUID REFERENCES cv_sessions(id) ON DELETE CASCADE NOT NULL,
    sender TEXT CHECK (sender IN ('user', 'ai')) NOT NULL,
    content TEXT NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS for chat_messages
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view messages from their sessions" 
ON chat_messages FOR SELECT 
USING (
    EXISTS (
        SELECT 1 FROM cv_sessions 
        WHERE cv_sessions.id = chat_messages.session_id 
        AND cv_sessions.user_id = auth.uid()
    )
);

CREATE POLICY "Users can insert messages to their sessions" 
ON chat_messages FOR INSERT 
WITH CHECK (
    EXISTS (
        SELECT 1 FROM cv_sessions 
        WHERE cv_sessions.id = chat_messages.session_id 
        AND cv_sessions.user_id = auth.uid()
    )
);

-- 4. Company Comparisons Table (Company Service)
CREATE TABLE company_comparisons (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
    business_link_a TEXT NOT NULL,
    business_link_b TEXT NOT NULL,
    analysis_result JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS for company_comparisons
ALTER TABLE company_comparisons ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own comparisons" 
ON company_comparisons FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own comparisons" 
ON company_comparisons FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- 5. Consultation Requests Table (New Company Service)
CREATE TABLE consultation_requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
    subject TEXT NOT NULL,
    message TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'reviewed', 'closed')),
    is_paid BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS for consultation_requests
ALTER TABLE consultation_requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own consultation requests" 
ON consultation_requests FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own consultation requests" 
ON consultation_requests FOR INSERT 
WITH CHECK (auth.uid() = user_id);

-- Triggers for handling new user creation (Supabase Auth -> public.profiles)
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (new.id, new.email, new.raw_user_meta_data->>'full_name');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- Admin policies (Admins can view/edit everything)
-- Note: You'll need to manually set the first admin in the database or via a migration script
CREATE POLICY "Admins can view all profiles" 
ON profiles FOR SELECT 
USING (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = auth.uid() AND role = 'admin'
  )
);

CREATE POLICY "Admins can update all profiles" 
ON profiles FOR UPDATE 
USING (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = auth.uid() AND role = 'admin'
  )
);

-- Grant permissions (optional, depending on default setup)
GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA public TO anon, authenticated, service_role;






















-- 6. Contact Submissions (For Public "Contact Us" Form)
CREATE TABLE contact_submissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email TEXT NOT NULL,
    subject TEXT,
    message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Enable Security
ALTER TABLE contact_submissions ENABLE ROW LEVEL SECURITY;

-- Allow ANYONE (even unauthenticated users) to insert data
CREATE POLICY "Public can insert contact forms" 
ON contact_submissions FOR INSERT WITH CHECK (true);

-- Allow ONLY Admins to view the data
CREATE POLICY "Admins can view contact forms" 
ON contact_submissions FOR SELECT 
USING (
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
);

-- Grant permissions to the Service Role (which n8n uses)
GRANT ALL ON contact_submissions TO service_role;
GRANT INSERT ON contact_submissions TO anon;
















UPDATE public.profiles
SET role = 'admin', credits_cv = 999
WHERE email = 'YOUR_EMAIL@EXAMPLE.COM';